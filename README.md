# 综合坐标转换工具
V0.2.2版本,可运行py和exe操作excel文件，批量转换坐标（4坐标系，12向），并存为新表加列
## 项目简介
综合坐标转换工具是一个功能强大的Python脚本，支持多种地理坐标系之间的批量转换，包括WGS84、高德(GCJ-02)、百度(BD09)和思极坐标系。该工具能够智能识别Excel文件中的经纬度列，批量处理数据并生成转换结果，适用于需要在不同地图服务和应用系统之间转换坐标的场景。

## 功能特点
- 支持12种常用坐标系转换模式
- 智能识别Excel文件中的经纬度列
- 批量处理Excel数据，自动生成转换结果
- 结果文件保留原始数据结构，新增转换列
- 详细日志记录，便于问题排查
- 支持Windows系统的可执行文件版本

## 功能模块

### 1. 坐标转换核心模块
实现了不同坐标系之间的精确转换算法，包括以下函数：

| 函数名 | 功能描述 |
|--------|----------|
| `wgs84_to_gcj02` | WGS84坐标系转高德坐标系(GCJ-02) |
| `gcj02_to_wgs84` | 高德坐标系(GCJ-02)转WGS84坐标系 |
| `gcj02_to_bd09` | 高德坐标系(GCJ-02)转百度坐标系(BD09) |
| `bd09_to_gcj02` | 百度坐标系(BD09)转高德坐标系(GCJ-02) |
| `wgs84_to_bd09` | WGS84坐标系转百度坐标系(BD09) |
| `bd09_to_wgs84` | 百度坐标系(BD09)转WGS84坐标系 |
| `gaode_to_sj` | 高德坐标系转思极坐标系 |
| `sj_to_gaode` | 思极坐标系转高德坐标系 |
| `wgs84_to_sj` | WGS84坐标系转思极坐标系 |
| `sj_to_wgs84` | 思极坐标系转WGS84坐标系 |
| `bd09_to_sj` | 百度坐标系转思极坐标系 |
| `sj_to_bd09` | 思极坐标系转百度坐标系 |

### 2. Excel文件处理模块
负责Excel文件的读取、数据处理和结果写入，支持.xlsx格式文件。

### 3. 智能列识别模块
通过关键词匹配自动识别Excel中的经纬度列，支持多种命名方式：
- WGS84坐标：包含'WGS84'、'84'等关键词的列
- 高德坐标：包含'高德'、'GCJ02'等关键词的列
- 百度坐标：包含'百度'、'BD09'等关键词的列
- 思极坐标：包含'思极'、'sj'等关键词的列

### 4. 日志模块
记录程序运行过程中的关键信息和错误，便于问题诊断和排查。

## 使用方法

### 前提条件
- Python 3.x环境
- 依赖库：pandas, openpyxl, math

### 运行步骤
1. 将待转换的Excel文件(.xlsx)放在程序同一目录下
2. 运行程序：`python 综合坐标转换工具.py` 或直接运行可执行文件
3. 根据菜单选择坐标转换模式（1-12）：
   ```
   1. WGS84 → 高德(GCJ-02)
   2. WGS84 → 百度(BD-09)
   3. WGS84 → 思极
   4. 思极 → 高德(GCJ-02)
   5. 思极 → 百度(BD-09)
   6. 思极 → WGS84
   7. 高德(GCJ-02) → WGS84
   8. 高德(GCJ-02) → 百度(BD-09)
   9. 高德(GCJ-02) → 思极
   10. 百度(BD-09) → WGS84
   11. 百度(BD-09) → 高德(GCJ-02)
   12. 百度(BD-09) → 思极
   ```
4. 输入要处理的Excel文件名
5. 程序自动处理并生成结果文件，格式为`原文件名-目标坐标系.xlsx`

## 坐标转换核心方法
本工具采用中国国家测绘局发布的坐标偏移算法，核心转换公式如下：

### 经纬度转换函数
```python
def transformlat(x, y):
    ret = -100.0 + 2.0 * x + 3.0 * y + 0.2 * y * y + 0.1 * x * y + 0.2 * math.sqrt(abs(x))
    ret += (20.0 * math.sin(6.0 * x * math.pi) + 20.0 * math.sin(2.0 * x * math.pi)) * 2.0 / 3.0
    ret += (20.0 * math.sin(y * math.pi) + 40.0 * math.sin(y / 3.0 * math.pi)) * 2.0 / 3.0
    ret += (160.0 * math.sin(y / 12.0 * math.pi) + 320 * math.sin(y * math.pi / 30.0)) * 2.0 / 3.0
    return ret

def transformlng(x, y):
    ret = 300.0 + x + 2.0 * y + 0.1 * x * x + 0.1 * x * y + 0.1 * math.sqrt(abs(x))
    ret += (20.0 * math.sin(6.0 * x * math.pi) + 20.0 * math.sin(2.0 * x * math.pi)) * 2.0 / 3.0
    ret += (20.0 * math.sin(x * math.pi) + 40.0 * math.sin(x / 3.0 * math.pi)) * 2.0 / 3.0
    ret += (150.0 * math.sin(x / 12.0 * math.pi) + 300.0 * math.sin(x / 30.0 * math.pi)) * 2.0 / 3.0
    return ret
```

### 坐标系转换原理
1. **WGS84与GCJ02转换**：基于地球椭球模型和国家保密算法，加入随机偏差
2. **GCJ02与BD09转换**：在GCJ02基础上进一步加入百度特有偏差
3. **WGS84与BD09转换**：通过GCJ02作为中间坐标系进行二次转换
4. **高德与思极转换**：基于机器学习模型（XGBoost），通过已知坐标对训练得到转换关系，能够学习复杂的非线性转换模式
5. **其他包含思极的转换**：通过高德坐标系作为中间坐标系进行二次转换（如WGS84→思极需先转高德再转思极）

## 项目特色

### 1. 智能列识别
无需手动指定经纬度列，程序自动识别包含特定关键词的列，支持多种命名方式，提高工作效率。

### 2. 批量高效处理
支持大型Excel文件的批量转换，保持原始数据结构，转换结果列插入在原始纬度列之后，便于数据对比。

### 3. 全面的转换支持
覆盖所有常用坐标系之间的转换路径，满足不同地图服务（高德地图、百度地图、谷歌地图等）的坐标需求。

### 4. 双重运行模式
既可以作为Python脚本运行，也可以通过提供的可执行文件直接运行，无需配置Python环境。

## 思极坐标转换模块
综合坐标转换工具中集成了思极坐标转换功能，通过机器学习模型实现高精度的坐标转换。

### 功能简介
思极坐标转换模块使用XGBoost机器学习模型，基于已知的坐标对数据，学习高德坐标系与思极坐标系之间的转换关系。模型训练完成后会自动保存，便于后续直接加载使用。

### 环境准备
安装额外依赖库：
```bash
pip install pandas numpy scikit-learn xgboost matplotlib seaborn openpyxl joblib
```

### 数据准备
1. 确保坐标数据保存在当前目录下，文件名为`坐标数据.xlsx`
2. 数据应包含以下列：
   - `高德经度`：高德坐标系的经度
   - `高德纬度`：高德坐标系的纬度
   - `思极经度`：思极坐标系的经度
   - `思极纬度`：思极坐标系的纬度

### 模型加载与使用
在综合坐标转换工具中，模型会自动加载：
```python
# 创建转换器实例
converter = CoordinateInferenceConverter()

# 加载已保存的模型
success = converter.load_model('gaode_to_sj')  # 高德转思极
# 或
success = converter.load_model('sj_to_gaode')  # 思极转高德
```

### 主要功能
- 自动加载Excel格式的坐标数据
- 支持随机森林和XGBoost两种模型训练
- 数据集自动划分（训练集80%，测试集20%）
- 模型性能评估（MSE和R2评分）
- 误差分布可视化
- 提供坐标转换测试和实际应用接口
- 自动保存训练好的模型到本地文件
- 支持从本地文件加载已训练的模型

### 模型保存位置
训练完成后，模型会自动保存到`model`目录下：
- 高德转思极模型：`model/gaode_to_sj_model.pkl`
- 思极转高德模型：`model/sj_to_gaode_model.pkl`

工具会自动从这些位置加载模型，无需手动指定路径。

### 测试模型正确性的步骤
1. **运行脚本**：执行`python sj.py`自动完成模型训练、评估和测试
2. **查看评估指标**：关注输出的MSE（均方误差）和R2（决定系数）值
   - MSE值越小越好，接近0表示模型预测越准确
   - R2值越接近1表示模型解释能力越强
3. **分析误差可视化**：查看生成的`误差分析.png`文件，了解误差分布情况
4. **检查转换测试结果**：脚本会随机选择测试样本，输出预测思极坐标与实际思极坐标的对比
5. **手动测试**：可以使用以下代码片段进行手动测试：
   ```python
   from sj import SJCoordinateConverter
   
   # 创建转换器实例
   converter = SJCoordinateConverter()
   
   # 加载已保存的模型
   model = converter.load_model()
   
   # 测试特定坐标
   gaode_lng, gaode_lat = 116.397489, 39.908823  # 示例坐标
   sj_lng, sj_lat = converter.convert(model, gaode_lng, gaode_lat)
   print(f"高德坐标: ({gaode_lng}, {gaode_lat}) 转换为思极坐标: ({sj_lng}, {sj_lat})")
   ```

### 模块与函数关系
`SJCoordinateConverter`类是工具的核心，包含以下主要方法，按执行流程排列：
1. `load_data()`：加载坐标数据
2. `prepare_data()`：准备训练和测试数据
3. `train_model()`：训练转换模型
4. `save_model()`：保存训练好的模型
5. `evaluate_model()`：评估模型性能
6. `visualize_errors()`：可视化误差分布
7. `test_conversion()`：测试转换功能
8. `convert()`：实际应用中的坐标转换

这些方法协同工作，从数据加载到模型训练，再到评估和应用，形成完整的坐标转换流程。

## 注意事项
1. 确保Excel文件格式正确，经纬度数据为数字格式
2. 程序仅处理.xlsx格式文件，不支持旧版.xls格式
3. 输出文件将保存在同一目录下，文件名包含转换目标坐标系
4. 如遇列识别失败，请检查列名是否包含坐标系关键词

## 错误处理
- 列识别失败：检查Excel列名是否包含正确的坐标系关键词
- 文件不存在：确保输入的文件名正确且文件位于程序目录下
- 权限错误：确保程序对目录有读写权限

所有错误信息将记录在app.log文件中，便于问题排查。